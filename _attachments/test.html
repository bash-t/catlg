<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Catlg Tests</title>
    <link rel="stylesheet" href="style/qunit.css">
  </head>
  <body>
    <h1 id="qunit-header">Catlg tests</h1>
    <h2 id="qunit-banner"></h2>
    <div id="qunit-testrunner-toolbar"></div>
    <h2 id="qunit-userAgent"></h2>
    <ol id="qunit-tests"></ol>
    <div id="qunit-fixture">test markup, will be hidden</div>
  </body>
  <script src="/_utils/script/jquery.js"></script>
  <script src="/_utils/script/jquery.couch.js"></script>
  <script src="script/catlg.js"></script>
  <script src="script/qunit.js"></script>
  <script>
    $(document).ready(function() {
      module('Setup');
      var db, fixture;
      asyncTest('check db', function() {
        db = catlg.db('catlg');
        db.info({
          success: function(resp) {
            equals(resp.db_name, 'catlg', 'db info');
            start();
          },
          error: function(stat, error, reason) {
            ok(false, reason);
            start();
          }
        });
      });
      asyncTest('get fixture', function() {
        $.getJSON('fixture.json', function(data) {
          fixture = data;
          ok(true, 'fine test');
          start();
        });
      });
      module('Index');
      asyncTest('exists', function() {
        $.ajax({
          url: 'index.html',
          complete: function(xhr) {
            equals(xhr.status, 200, 'index.html status');
            start();
          }
        });
      });
      module('Models');
      asyncTest('create and delete good book', function() {
        var doc = fixture.goodbook;
        db.createDoc(doc, {
          success: function(resp) {
            ok(true, 'doc ' + resp.id + ' created');
            doc._id = resp.id;
            doc._rev = resp.rev;
            db.removeDoc(doc, {
              success: function(resp) {
                ok(true, 'doc ' + resp.id + ' deleted');
                start();
              },
              error: function(stat, error, reason) {
                ok(false, reason);
                start();
              }
            });
          },
          error: function(stat, error, reason) {
            ok(false, reason);
            start();
          }
        });
      });
      asyncTest('fail to create typeless doc', function() {
        var doc = fixture.typeless;
        db.createDoc(doc, {
          success: function(resp) {
            ok(false, 'Oh no, doc created');
            doc = {
              _id: resp.id,
              _rev: resp.rev
            };
            db.removeDoc(doc);
            start();
          },
          error: function(stat, error, reason) {
            equals(reason, 'The "type" field must match a model.', 'Success!');
            start();
          }
        });
      });
      asyncTest('fail to create doc with type that matches no models', function() {
        var doc = fixture.noModelMatch;
        db.createDoc(doc, {
          success: function(resp) {
            ok(false, 'Oh no, doc created');
            doc = {
              _id: resp.id,
              _rev: resp.rev
            };
            db.removeDoc(doc);
            start();
          },
          error: function(stat, error, reason) {
            equals(reason, 'The "type" field must match a model.', 'Success!');
            start();
          },
        });
      });
      module('Views');
      asyncTest('save bulk', function() {
        db.bulkCreate(fixture.bulk, {
          success: function(resp) {
            fixture.bulk.docs = [];
            var newDoc;
            var docsStr = ''
            $.each(resp, function(i, doc) {
              newDoc = {
                _id: doc.id,
                _rev: doc.rev
              };
              fixture.bulk.docs.push(newDoc);
              docsStr += ' ' + doc.id;
            });
            ok(true, 'saved docs' + docsStr);
            start();
          },
          error: function(stat, error, reason) {
            ok(false, reason);
            start();
          }
        });
      });
      asyncTest('title', function() {
        db.view('catlg/title', {
          success: function(resp) {
            equals(resp.rows[1].key, "L'Ã‰tranger");
            start();
          },
          error: function(stat, error, reason) {
            ok(false, reason);
            start();
          }
        });
      });
      asyncTest('author', function() {
        db.view('catlg/author', {
          success: function(resp) {
            equals(resp.rows[1].key, "Camus, Albert");
            start();
          },
          error: function(stat, error, reason) {
            ok(false, reason);
            start();
          }
        });
      });
      asyncTest('remove bulk', function() {
        db.bulkRemove(fixture.bulk, {
          success: function(resp) {
            ok(true, 'removed bulk docs');
            start();
          },
          error: function(stat, error, reason) {
            ok(false, reason);
            start();
          }
        });
      });
    });
  </script>
</html>
